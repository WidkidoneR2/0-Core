#!/usr/bin/env bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”„ Dotfiles Auto-Sync - Faelight Forest
# Automatically syncs config changes to GitHub
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -e

DOTFILES_DIR="$HOME/dotfiles"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘       ğŸ”„ DOTFILES AUTO-SYNC - FAELIGHT FOREST           â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Check if dotfiles directory exists
if [ ! -d "$DOTFILES_DIR" ]; then
    echo "âŒ Error: Dotfiles directory not found at $DOTFILES_DIR"
    exit 1
fi

cd "$DOTFILES_DIR"

# Check if git repo
if [ ! -d ".git" ]; then
    echo "âŒ Error: Not a git repository"
    exit 1
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“¦ SYNC CURRENT CONFIGS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${CYAN}ğŸ“¦ Syncing current configs...${NC}"
echo ""

# Fish Shell
echo "ğŸ  Syncing Fish Shell..."
cp ~/.config/fish/config.fish fish/ 2>/dev/null || true
cp -r ~/.config/fish/functions fish/ 2>/dev/null || true

# Hyprland
echo "ğŸ–¥ï¸  Syncing Hyprland..."
cp ~/.config/hypr/*.conf hypr/ 2>/dev/null || true

# Waybar
echo "ğŸ“Š Syncing Waybar..."
cp ~/.config/waybar/config.jsonc waybar/ 2>/dev/null || true
cp ~/.config/waybar/style.css waybar/ 2>/dev/null || true

# Kitty
echo "ğŸ± Syncing Kitty..."
cp ~/.config/kitty/kitty.conf kitty/ 2>/dev/null || true

# Yazi
echo "ğŸ“ Syncing Yazi..."
mkdir -p yazi
cp ~/.config/yazi/yazi.toml yazi/ 2>/dev/null || true
cp ~/.config/yazi/theme.toml yazi/ 2>/dev/null || true

# LazyVim
echo "ğŸ“ Syncing LazyVim..."
cp -r ~/.config/nvim/lua nvim/ 2>/dev/null || true

# Scripts
echo "ğŸ”§ Syncing scripts..."
cp ~/.local/bin/sys-cleanup scripts/ 2>/dev/null || true
cp ~/.local/bin/quick-note scripts/ 2>/dev/null || true
cp ~/.local/bin/safe-update scripts/ 2>/dev/null || true
cp ~/.local/bin/dotfiles-sync scripts/ 2>/dev/null || true

# Documentation
echo "ğŸ“š Syncing documentation..."
cp ~/faelight-forest-docs/COMPLETE_GUIDE.md docs/ 2>/dev/null || true

# Package list
echo "ğŸ“¦ Saving package list..."
pacman -Qqe > pkglist.txt

echo ""
echo -e "${GREEN}âœ… Sync complete!${NC}"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ” CHECK FOR CHANGES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if ! git diff --quiet || ! git diff --cached --quiet; then
    echo -e "${CYAN}ğŸ“Š Changes detected:${NC}"
    echo ""
    git status --short
    echo ""
    
    # Count changes
    CHANGES=$(git status --short | wc -l)
    echo "Total files changed: $CHANGES"
    echo ""
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ’¾ COMMIT & PUSH
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    # Check if running interactively
    if [ -t 0 ]; then
        # Interactive mode - ask user
        read -p "Commit and push changes? [Y/n]: " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
            SHOULD_COMMIT=true
        else
            SHOULD_COMMIT=false
        fi
    else
        # Non-interactive (cron) - auto-commit if changes
        SHOULD_COMMIT=true
    fi
    
    if [ "$SHOULD_COMMIT" = true ]; then
        # Get commit message
        if [ -t 0 ]; then
            # Interactive - ask for message
            read -p "Commit message (or press Enter for auto): " COMMIT_MSG
            if [ -z "$COMMIT_MSG" ]; then
                COMMIT_MSG="ğŸ”„ Auto-sync dotfiles $(date +%Y-%m-%d)"
            fi
        else
            # Non-interactive - auto message
            COMMIT_MSG="ğŸ”„ Auto-sync dotfiles $(date +%Y-%m-%d)"
        fi
        
        echo ""
        echo "ğŸ’¾ Committing changes..."
        git add -A
        git commit -m "$COMMIT_MSG"
        
        # Push to GitHub
        echo "ğŸš€ Pushing to GitHub..."
        if git push; then
            echo ""
            echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
            echo -e "${GREEN}â•‘          âœ… DOTFILES SYNCED TO GITHUB!                  â•‘${NC}"
            echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
            echo ""
        else
            echo ""
            echo -e "${YELLOW}âš ï¸  Push failed - you may need to pull first${NC}"
            echo "   Run: cd ~/dotfiles && git pull && git push"
            exit 1
        fi
    else
        echo "Sync cancelled."
        exit 0
    fi
else
    echo -e "${GREEN}âœ… No changes to sync - dotfiles are up to date!${NC}"
    echo ""
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“Š STATS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo "ğŸ“Š Repository Stats:"
echo "   Total commits: $(git rev-list --count HEAD)"
echo "   Last sync: $(git log -1 --format=%cd --date=relative)"
echo "   Repository: https://github.com/WidkidoneR2/dotfiles"
echo ""

echo "ğŸŒ² Dotfiles sync complete!"
echo ""
