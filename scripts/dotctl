#!/bin/bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ® dotctl - 0-Core Control Utility
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Central command for managing 0-core system
#
# Usage: dotctl <command> [args]
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -euo pipefail

CORE_DIR="$HOME/0-core"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Functions
cmd_status() {
  echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  echo -e "${CYAN}ğŸ“Š 0-Core System Status${NC}"
  echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  echo ""

  # System version
  if [ -f "$CORE_DIR/VERSION" ]; then
    SYS_VERSION=$(cat "$CORE_DIR/VERSION")
    echo -e "${GREEN}System Version:${NC} v$SYS_VERSION"
  fi

  echo ""
  echo -e "${BLUE}Package Versions:${NC}"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # List all packages with versions
  for dotmeta in "$CORE_DIR"/*/.dotmeta; do
    if [ -f "$dotmeta" ]; then
      PKG=$(dirname "$dotmeta")
      PKG_NAME=$(basename "$PKG")
      VERSION=$(grep '^version = ' "$dotmeta" | head -1 | awk -F'"' '{print $2}')
      CATEGORY=$(grep '^category = ' "$dotmeta" | awk -F'"' '{print $2}')
      BLAST=$(grep '^blast_radius = ' "$dotmeta" | awk -F'"' '{print $2}')

      # Color based on blast radius
      case "$BLAST" in
      critical) COLOR="${RED}ğŸ”´${NC}" ;;
      high) COLOR="${YELLOW}ğŸŸ ${NC}" ;;
      medium) COLOR="${BLUE}ğŸ”µ${NC}" ;;
      low) COLOR="${GREEN}ğŸŸ¢${NC}" ;;
      *) COLOR="${GREEN}ğŸŸ¢${NC}" ;;
      esac

      printf "  %b %-25s v%-8s (%s)\n" "$COLOR" "$PKG_NAME" "$VERSION" "$CATEGORY"
    fi
  done

  echo ""
  echo -e "${BLUE}Latest Update:${NC}"
  if [ -x "$CORE_DIR/scripts/latest-update" ]; then
    LATEST=$("$CORE_DIR/scripts/latest-update")
    echo "  $LATEST"
  fi

  echo ""
  echo -e "${BLUE}Health Status:${NC}"
  if command -v dot-doctor &>/dev/null; then
    HEALTH=$(dot-doctor 2>/dev/null | grep "Health:" | awk '{print $2}')
    if [ "$HEALTH" = "100%" ]; then
      echo -e "  ${GREEN}âœ… $HEALTH${NC}"
    else
      echo -e "  ${YELLOW}âš ï¸  $HEALTH${NC}"
    fi
  else
    echo "  Unknown (dot-doctor not found)"
  fi

  echo ""
  echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
}

cmd_bump() {
  if [ $# -lt 2 ]; then
    echo "Usage: dotctl bump <package> <version> [change-note]"
    echo ""
    echo "Example: dotctl bump shell-fish 3.3.1 'Added new features'"
    exit 1
  fi

  "$CORE_DIR/scripts/bump-version" "$@"
}

cmd_history() {
  if [ $# -lt 1 ]; then
    echo "Usage: dotctl history <package>"
    exit 1
  fi

  PACKAGE="$1"
  DOTMETA="$CORE_DIR/$PACKAGE/.dotmeta"

  if [ ! -f "$DOTMETA" ]; then
    echo "âŒ No .dotmeta found for package: $PACKAGE"
    exit 1
  fi

  echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  echo -e "${CYAN}ğŸ“œ Changelog: $PACKAGE${NC}"
  echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  echo ""

  # Extract and format changelog
  grep '^"[0-9]' "$DOTMETA" | while IFS= read -r line; do
    VERSION=$(echo "$line" | cut -d'"' -f2)
    CHANGE=$(echo "$line" | cut -d'"' -f4)
    echo -e "  ${GREEN}v$VERSION${NC}: $CHANGE"
  done

  echo ""
}

cmd_health() {
  if command -v dot-doctor &>/dev/null; then
    dot-doctor
  else
    echo "âŒ dot-doctor not found"
    exit 1
  fi
}

cmd_help() {
  cat <<'HELP'
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ® dotctl - 0-Core Control Utility
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

COMMANDS:
  status              Show system and package versions
  bump <pkg> <ver>    Bump package version
  history <pkg>       Show package changelog
  health              Run system health check
  help                Show this help

EXAMPLES:
  dotctl status
  dotctl bump shell-fish 3.3.1 "Added aliases"
  dotctl history wm-hypr
  dotctl health

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
HELP
}

# Main
COMMAND="${1:-help}"

case "$COMMAND" in
status) cmd_status ;;
bump)
  shift
  cmd_bump "$@"
  ;;
history)
  shift
  cmd_history "$@"
  ;;
health) cmd_health ;;
help) cmd_help ;;
*)
  echo "Unknown command: $COMMAND"
  cmd_help
  exit 1
  ;;
esac
